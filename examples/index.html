<!doctype html>
<title>term.js</title>
<!--
  term.js
  Copyright (c) 2012-2013, Christopher Jeffrey (MIT License)
-->
<style>
  html {
    background: #555;
  }

  h1 {
    margin-bottom: 20px;
    font: 20px/1.5 sans-serif;
  }

/*
  .terminal {
    float: left;
    border: #000 solid 5px;
    font-family: "DejaVu Sans Mono", "Liberation Mono", monospace;
    font-size: 11px;
    color: #f0f0f0;
    background: #000;
  }

  .terminal-cursor {
    color: #000;
    background: #f0f0f0;
  }
*/
</style>
<h1>term.js</h1>
<script src="term.js"></script>
<script>
;(function() {
  window.onload = function() {
    var socket = new WebSocket('ws://localhost:8081/a?command=%5B%22%2Fbin%2Fbash%22%5D&tty=true');
    socket.onopen = function() {
      var term = new Terminal({
        cols: 80,
        rows: 24,
        useStyle: true,
        screenKeys: true,
        cursorBlink: false
      });

      term.on('data', function(data) {
        socket.send(data);
      });

      term.on('title', function(title) {
        document.title = title;
      });

      term.open(document.body);

      // socket.send('/bin/bash');

      //socket.binaryType = 'arraybuffer'

      socket.onmessage = function (msg) {
        //ready message recieved
        term.write('\x1b[31mReady\x1b[m\r\n');
        socket.onmessage = function (msg) {
          // if ((new Int8Array(msg.data))[0] === 100) {
          //   term.write('\r\nProcess exited with code '+(new Int32Array(msg.data.slice(1)))[0]+'\r\n');
          // }
          // else {
          //   term.write(msg.data.slice(1));
          // }
          var fileReader = new FileReader();
          fileReader.readAsArrayBuffer(msg.data.slice(0,1));
          fileReader.onload = function () {

            if((new Int8Array(fileReader.result))[0] === 100) {
              fileReader.readAsArrayBuffer(msg.data.slice(1));
              fileReader.onload = function () {
                term.write('\r\nProcess exited with code '+(new Int32Array(fileReader.result))[0]+'\r\n');
              };
            }

            else { // Ignoring the first byte because it contains 01:stdout or 02:stderr
              fileReader.readAsBinaryString(msg.data.slice(1));
              fileReader.onload = function () {
                term.write(fileReader.result);
              };
            }
          };
        };
      };

      socket.onclose = function() {
        term.destroy();
      };
    };
  };
}).call(this);
</script>